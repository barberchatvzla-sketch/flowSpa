<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Glow Admin Portal - SaaS</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --bg: #050505;
            --card: #111;
            --text: #fff;
            --accent: #E000E0;
            --success: #00E08F;
            --danger: #FF2E2E;
            --gray: #888;
            --border: #222;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Manrope', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* LOGIN SCREEN */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 99999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px;
        }
        
        .brand { font-family: 'Playfair Display', serif; font-size: 3rem; margin-bottom: 30px; }
        .brand span { color: var(--accent); }

        .login-box { width: 100%; max-width: 350px; text-align: center; }
        
        input {
            width: 100%; padding: 15px; background: #222; border: 1px solid #333;
            color: white; border-radius: 12px; font-size: 1.1rem;
            margin-bottom: 20px; outline: none; letter-spacing: 1px;
        }
        input:focus { border-color: var(--accent); }
        
        #businessCodeInput { text-align: center; text-transform: uppercase; letter-spacing: 2px; }

        button {
            width: 100%; padding: 15px; border-radius: 50px; border: none;
            font-weight: 600; cursor: pointer; transition: 0.3s; font-size: 1rem;
        }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 0 20px rgba(224,0,224,0.3); }
        .btn-primary:hover { transform: scale(1.02); box-shadow: 0 0 30px rgba(224,0,224,0.5); }

        /* DASHBOARD LAYOUT */
        #dashboard { 
            display: none; flex-direction: column; height: 100%;
            max-width: 1000px; margin: 0 auto; width: 100%; 
        }
        
        .header-section { padding: 20px; padding-bottom: 0; flex-shrink: 0; }

        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .header h2 { font-family: 'Playfair Display', serif; }
        
        .header-actions { display: flex; gap: 10px; align-items: center; }
        
        .logout { background: transparent; color: var(--gray); width: auto; padding: 5px 10px; font-size: 0.9rem; }
        
        /* BOTÓN DE NOTIFICACIONES */
        #btn-notif-status {
            background: #222; color: #888; width: auto; padding: 8px 15px; font-size: 0.85rem;
            display: flex; align-items: center; gap: 8px; border: 1px solid #333;
            cursor: pointer;
        }
        #btn-notif-status:hover { background: #333; }
        #btn-notif-status.active { background: rgba(0, 224, 143, 0.1); color: var(--success); border-color: rgba(0, 224, 143, 0.3); }

        /* NAV TABS */
        .nav-tabs { display: flex; gap: 20px; margin-bottom: 15px; border-bottom: 1px solid var(--border); overflow-x: auto; flex-shrink: 0; }
        .tab-btn {
            background: transparent; color: var(--gray); padding: 10px 5px; border-radius: 0; width: auto; white-space: nowrap;
            border-bottom: 2px solid transparent; cursor: pointer; font-size: 1rem;
        }
        .tab-btn.active { color: var(--text); border-bottom-color: var(--accent); }
        
        /* SCROLLABLE CONTENT AREA */
        .content-scroll-area {
            flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; position: relative;
        }

        /* CONFIGURACIÓN / MI SALÓN STYLES */
        .config-card { background: var(--card); padding: 25px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 25px; }
        .config-card h3 { font-family: 'Playfair Display'; margin-bottom: 20px; border-bottom: 1px solid #222; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-label { display: block; color: var(--gray); margin-bottom: 8px; font-size: 0.9rem; }
        .form-input { 
            width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; 
            border-radius: 8px; color: white; font-size: 1rem; margin-bottom: 5px;
        }
        
        .srv-edit-input {
            background: transparent; border: none; border-bottom: 1px solid #444; 
            color: white; width: 100%; padding: 4px 0; outline: none; font-size: 0.9rem;
            transition: border-color 0.3s;
        }
        .srv-edit-input:focus { border-color: var(--accent); }
        .srv-edit-price { color: var(--accent); font-weight: bold; }

        .services-list-config { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .srv-config-item { 
            background: #1a1a1a; border-radius: 12px; overflow: hidden; position: relative; border: 1px solid #333;
        }
        .srv-config-img { width: 100%; height: 100px; object-fit: cover; }
        .srv-config-info { padding: 10px; display: flex; flex-direction: column; gap: 5px; }
        
        .btn-delete-srv {
            position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: var(--danger);
            border: none; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2;
        }

        .add-srv-box { 
            background: #151515; border: 1px dashed #444; padding: 15px; border-radius: 12px;
            display: flex; flex-direction: column; gap: 10px;
        }

        /* VIEWS */
        .view-section { display: none; height: 100%; }
        .view-section.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* TOAST & CALENDAR & LIST STYLES */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 100000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: rgba(20, 20, 20, 0.95); border: 1px solid #333; border-left: 4px solid var(--accent); color: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); backdrop-filter: blur(10px); min-width: 300px; transform: translateX(120%); transition: transform 0.4s; pointer-events: all; display: flex; align-items: center; gap: 15px; }
        .toast.active { transform: translateX(0); }
        
        .calendar-stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .c-stat-box { background: linear-gradient(145deg, #1a1a1a, #111); padding: 20px; border-radius: 20px; border: 1px solid var(--border); overflow: hidden; }
        .c-stat-box h3 { font-size: 2.5rem; font-family: 'Playfair Display', serif; margin-bottom: 5px; }
        .c-stat-box p { color: #888; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }
        .progress-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 1s ease; }

        .calendar-frame { background: var(--card); border-radius: 24px; padding: 20px; border: 1px solid var(--border); }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
        .cal-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; position: relative; border: 1px solid transparent; }
        .cal-day:hover { background: #222; }
        .cal-day.today { background: #222; color: var(--accent); border-color: var(--accent); font-weight: bold; }
        .cal-dot { width: 5px; height: 5px; background: var(--accent); border-radius: 50%; margin-top: 4px; opacity: 0; }
        .cal-day.has-event .cal-dot { opacity: 1; }
        .cal-day.has-event.pending .cal-dot { background: #ffcc00; }

        .bookings-list { display: flex; flex-direction: column; gap: 15px; }
        .booking-card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
        .b-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .status-badge { padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; }
        .st-pendiente { background: #332b00; color: #ffcc00; }
        .st-confirmada { background: #003322; color: #00E08F; }
        .st-cancelada { background: #330000; color: #FF2E2E; }
        .btn-action { padding: 10px; border-radius: 8px; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; }
        .btn-approve { background: rgba(0, 224, 143, 0.1); color: var(--success); border: 1px solid rgba(0, 224, 143, 0.3); }
        .btn-reject { background: rgba(255, 46, 46, 0.1); color: var(--danger); border: 1px solid rgba(255, 46, 46, 0.3); }

        /* CHAT */
        .chat-layout { display: grid; grid-template-columns: 320px 1fr; gap: 0; height: 100%; min-height: 500px; background: var(--card); border-radius: 16px; overflow: hidden; border: 1px solid var(--border); }
        .chat-list { border-right: 1px solid var(--border); overflow-y: auto; background: #111; height: 100%; }
        .chat-item { padding: 18px 20px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .chat-item.active { background: #222; border-left: 3px solid var(--accent); }
        .chat-view { display: flex; flex-direction: column; background: #050505; height: 100%; position: relative; }
        .cv-body { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .cv-footer { padding: 15px; background: #111; display: flex; gap: 10px; border-top: 1px solid var(--border); }
        .msg-bubble { max-width: 75%; padding: 12px 16px; border-radius: 18px; font-size: 0.95rem; color: white; }
        .msg-bubble.admin { align-self: flex-end; background: var(--accent); }
        .msg-bubble.cliente { align-self: flex-start; background: #222; }

        @media (max-width: 768px) {
            #dashboard { height: 100vh; overflow: hidden; }
            .content-scroll-area { padding: 15px; padding-bottom: 20px; }
            .chat-layout { display: block; border: none; background: transparent; height: 100%; }
            .chat-list { height: 100%; }
            .chat-view { position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh; z-index: 10000; transform: translateX(100%); transition: transform 0.3s; }
            .chat-view.active { transform: translateX(0); }
            .header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .header-actions { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>
    <audio id="notifySound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div id="login-screen">
        <div class="brand">GLOW<span>.</span> Admin</div>
        <div class="login-box">
            <p style="color:#888; margin-bottom:15px;">Ingresa tu Código de Negocio</p>
            <input type="text" id="businessCodeInput" placeholder="EJ: MARIA88" maxlength="20">
            <button class="btn-primary" onclick="admin.login()">Entrar al Portal</button>
            <p id="loginError" style="color:var(--danger); margin-top:15px; display:none;">Código requerido</p>
        </div>
    </div>

    <div id="dashboard">
        <div class="header-section">
            <div class="header">
                <div>
                    <h2 id="dashTitle">Portal Admin</h2>
                    <p style="color:var(--gray); font-size:0.9rem;" id="dashCodeDisplay">--</p>
                </div>
                <div class="header-actions">
                    <button id="btn-notif-status" onclick="pushService.enable()">
                        <i class="ph ph-bell-slash"></i> Activar Notificaciones
                    </button>
                    <button class="logout" onclick="admin.logout()">Salir</button>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="tab-btn active" onclick="admin.switchTab('calendar', this)">Calendario</button>
                <button class="tab-btn" onclick="admin.switchTab('reservas', this)">Lista</button>
                <button class="tab-btn" onclick="admin.switchTab('mensajes', this)">Mensajes <span id="msgNotify" style="display:none; color:var(--accent)">•</span></button>
                <button class="tab-btn" onclick="admin.switchTab('config', this)"><i class="ph ph-gear"></i> Mi Salón</button>
            </div>
        </div>

        <div class="content-scroll-area">
            
            <div id="view-calendar" class="view-section active">
                <div class="calendar-stats-container">
                    <div class="c-stat-box">
                        <h3 id="cStatConfirmed" style="color:var(--success)">0</h3>
                        <p>Confirmadas</p>
                        <div class="progress-bg"><div class="progress-fill" id="progConfirmed" style="background:var(--success); width:0%"></div></div>
                    </div>
                    <div class="c-stat-box">
                        <h3 id="cStatPending" style="color:#ffcc00">0</h3>
                        <p>Pendientes</p>
                        <div class="progress-bg"><div class="progress-fill" id="progPending" style="background:#ffcc00; width:0%"></div></div>
                    </div>
                </div>

                <div class="calendar-frame">
                    <div class="cal-header">
                        <button class="cal-nav-btn" onclick="adminCalendar.changeMonth(-1)" style="background:none; border:none; color:white; font-size:1.2rem;"><i class="ph ph-caret-left"></i></button>
                        <h3 id="calMonthLabel">--</h3>
                        <button class="cal-nav-btn" onclick="adminCalendar.changeMonth(1)" style="background:none; border:none; color:white; font-size:1.2rem;"><i class="ph ph-caret-right"></i></button>
                    </div>
                    <div class="cal-grid">
                        <div class="cal-day-name" style="color:#666; font-size:0.8rem;">D</div><div class="cal-day-name" style="color:#666; font-size:0.8rem;">L</div>
                        <div class="cal-day-name" style="color:#666; font-size:0.8rem;">M</div><div class="cal-day-name" style="color:#666; font-size:0.8rem;">M</div>
                        <div class="cal-day-name" style="color:#666; font-size:0.8rem;">J</div><div class="cal-day-name" style="color:#666; font-size:0.8rem;">V</div>
                        <div class="cal-day-name" style="color:#666; font-size:0.8rem;">S</div>
                    </div>
                    <div class="cal-grid" id="calDaysGrid"></div>
                </div>
            </div>

            <div id="view-reservas" class="view-section">
                <div style="display:flex; gap:10px; margin-bottom:20px; overflow-x:auto;">
                    <button onclick="admin.filter('todas')" class="btn-primary" style="width:auto; padding:8px 15px; font-size:0.9rem;">Todas</button>
                    <button onclick="admin.filter('pendiente')" style="background:#222; border:none; color:#ccc; border-radius:20px; padding:8px 15px;">Pendientes</button>
                </div>
                <div class="bookings-list" id="bookingsList"></div>
            </div>

            <div id="view-config" class="view-section">
                
                <div class="config-card">
                    <h3>Enlace Público</h3>
                    <p style="color:#666; font-size:0.9rem; margin-bottom:10px;">Comparte este link con tus clientes para que reserven:</p>
                    <div style="display:flex; gap:10px;">
                        <input type="text" class="form-input" id="publicLinkDisplay" readonly style="margin-bottom:0; cursor:text;">
                        <button class="btn-primary" style="width:auto; aspect-ratio:1;" onclick="admin.copyLink()"><i class="ph ph-copy"></i></button>
                    </div>
                    <a href="#" id="openLinkBtn" target="_blank" style="display:block; margin-top:10px; color:var(--accent); text-decoration:none; font-size:0.9rem; display:flex; align-items:center; gap:5px;">
                        Abrir página <i class="ph ph-arrow-square-out"></i>
                    </a>
                </div>

                <div class="config-card">
                    <h3>Identidad del Negocio</h3>
                    <div class="form-group">
                        <label class="form-label">Nombre del Salón</label>
                        <input type="text" class="form-input" id="cfgNombreSalon" placeholder="Ej: Glow Spa">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre Encargada (Para el Chat)</label>
                        <input type="text" class="form-input" id="cfgEncargada" placeholder="Ej: Sofía">
                    </div>
                    <div class="form-group">
                        <label class="form-label">URL Portada (Fondo)</label>
                        <input type="text" class="form-input" id="cfgPortada" placeholder="https://...">
                    </div>
                </div>

                <div class="config-card">
                    <h3>Mis Servicios</h3>
                    <div class="services-list-config" id="cfgServicesList"></div>
                    <div class="add-srv-box">
                        <h4 style="font-size:1rem; margin-bottom:10px;">Agregar Nuevo Servicio</h4>
                        <input type="text" class="form-input" id="newSrvName" placeholder="Nombre (Ej: Manicure)">
                        <input type="text" class="form-input" id="newSrvPrice" placeholder="Precio (Ej: $25)">
                        <input type="text" class="form-input" id="newSrvImg" placeholder="URL Imagen (Ej: https://...)">
                        <button class="btn-primary" onclick="admin.addService()">+ Agregar Servicio</button>
                    </div>
                </div>

                <button class="btn-primary" style="position:sticky; bottom:20px; box-shadow:0 10px 40px rgba(224,0,224,0.4);" onclick="admin.saveConfig()">
                    <i class="ph ph-floppy-disk"></i> Guardar Cambios
                </button>
                <br><br>
            </div>

            <div id="view-mensajes" class="view-section">
                <div class="chat-layout">
                    <div class="chat-list" id="inboxList"></div>
                    <div class="chat-view" id="adminChatView">
                        <div style="padding:15px; border-bottom:1px solid #222; display:flex; align-items:center;">
                            <button onclick="adminChat.closeMobile()" style="background:none; border:none; color:white; font-size:1.5rem; margin-right:10px; display:none;" id="chatBackBtn"><i class="ph ph-arrow-left"></i></button>
                            <span id="chatActiveUser">Selecciona un chat</span>
                        </div>
                        <div class="cv-body" id="adminChatBody"></div>
                        <div class="cv-footer" id="chatFooterInput" style="display:none;">
                            <input type="text" id="adminChatInput" placeholder="Escribe..." style="background:#222; border:none; color:white; padding:12px; border-radius:20px; flex:1; outline:none;" onkeypress="if(event.key === 'Enter') adminChat.send()">
                            <button onclick="adminChat.send()" style="width:45px; height:45px; border-radius:50%; background:var(--accent); border:none; color:white; display:flex; align-items:center; justify-content:center;"><i class="ph ph-paper-plane-right"></i></button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; display:none; align-items:center; justify-content:center;" id="dateModal" onclick="if(event.target === this) adminCalendar.closeModal()">
        <div style="background:#151515; padding:30px; border-radius:20px; width:90%; max-width:400px; border:1px solid #333;">
            <h2 id="modalDateTitle" style="font-family:'Playfair Display'; margin-bottom:5px;">--</h2>
            <div id="modalEventList" style="margin-top:20px; display:flex; flex-direction:column; gap:10px;"></div>
            <button onclick="adminCalendar.closeModal()" style="margin-top:20px; background:#333; color:white; width:100%; padding:12px; border-radius:10px; border:none;">Cerrar</button>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN SUPABASE
        const SUPABASE_URL = 'https://luwcggpjvsrhvdwjiarw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1d2NnZ3BqdnNyaHZkd2ppYXJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NjE4NTcsImV4cCI6MjA4MzIzNzg1N30.L_Yl3cVXdvLGcz3VZD-icJXAE4_myxqGo6o5dAkKw0M';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // DEFAULT DEMO DATA
        const DEMO_CONFIG = {
            nombre_salon: 'GLOW',
            nombre_encargada: 'Sofía Hernández',
            imagen_portada: 'https://i.ibb.co/67C1hcrb/1767558273844.png',
            servicios: [
                { name: 'Corte y Secado', price: '$20', img: 'https://i.ibb.co/MDjWPmnP/1768612232066.png' },
                { name: 'Color y Mechas', price: '$50', img: 'https://i.ibb.co/HfSxF2BS/1768649929059.png' },
                { name: 'Manicure', price: '$15', img: 'https://i.ibb.co/HT95Xhqc/1768612130852.png' }
            ]
        };

        const notifications = {
            show(title, message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `<i class="ph ph-bell" style="font-size:1.5rem; color:var(--accent)"></i><div><h4 style="margin:0; font-size:0.9rem">${title}</h4><p style="margin:0; font-size:0.8rem; color:#aaa">${message}</p></div>`;
                container.appendChild(toast);
                document.getElementById('notifySound').play().catch(()=>{});
                setTimeout(()=>toast.classList.add('active'),10);
                setTimeout(()=>{ toast.classList.remove('active'); setTimeout(()=>toast.remove(),400); }, 5000);
            }
        };

        const admin = {
            code: null, data: [], currentConfig: {...DEMO_CONFIG},
            
            init() {
                const storedCode = localStorage.getItem('glowAdminCode');
                if(storedCode) {
                    document.getElementById('businessCodeInput').value = storedCode;
                    this.login();
                }
            },

            async login() {
                const val = document.getElementById('businessCodeInput').value.trim().toUpperCase();
                if(!val) return;
                this.code = val;
                localStorage.setItem('glowAdminCode', val);
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                document.getElementById('dashCodeDisplay').textContent = `Código: ${this.code}`;
                
                this.loadData();
                this.loadConfig();
                
                // INICIAR CHEQUEO DE NOTIFICACIONES
                pushService.init(); 
            },

            logout() { localStorage.removeItem('glowAdminCode'); location.reload(); },

            switchTab(tabName, btn) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                if(btn) btn.classList.add('active');
                document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
                document.getElementById(`view-${tabName}`).classList.add('active');
            },

            // --- LÓGICA DE CONFIGURACIÓN ---
            async loadConfig() {
                const { data } = await supabaseClient.from('negocios').select('*').eq('codigo_negocio', this.code).single();
                if(data) {
                    this.currentConfig = {
                        nombre_salon: data.nombre_salon || DEMO_CONFIG.nombre_salon,
                        nombre_encargada: data.nombre_encargada || DEMO_CONFIG.nombre_encargada,
                        imagen_portada: data.imagen_portada || DEMO_CONFIG.imagen_portada,
                        servicios: data.servicios || DEMO_CONFIG.servicios
                    };
                }
                this.renderConfigForm();
            },

            renderConfigForm() {
                const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                const publicUrl = `${baseUrl}spa.html?ref=${this.code}`;
                
                document.getElementById('publicLinkDisplay').value = publicUrl;
                document.getElementById('openLinkBtn').href = publicUrl;

                document.getElementById('cfgNombreSalon').value = this.currentConfig.nombre_salon;
                document.getElementById('cfgEncargada').value = this.currentConfig.nombre_encargada;
                document.getElementById('cfgPortada').value = this.currentConfig.imagen_portada;
                
                const list = document.getElementById('cfgServicesList');
                list.innerHTML = '';
                this.currentConfig.servicios.forEach((srv, idx) => {
                    const div = document.createElement('div'); div.className = 'srv-config-item';
                    div.innerHTML = `
                        <button class="btn-delete-srv" onclick="admin.removeService(${idx})"><i class="ph ph-trash"></i></button>
                        <img src="${srv.img}" class="srv-config-img" onerror="this.src='https://via.placeholder.com/150'">
                        <div class="srv-config-info">
                            <input type="text" class="srv-edit-input" value="${srv.name}" 
                                onchange="admin.updateServiceField(${idx}, 'name', this.value)" placeholder="Nombre">
                            <input type="text" class="srv-edit-input srv-edit-price" value="${srv.price || ''}" 
                                onchange="admin.updateServiceField(${idx}, 'price', this.value)" placeholder="Precio">
                        </div>
                    `;
                    list.appendChild(div);
                });
            },

            copyLink() {
                const input = document.getElementById('publicLinkDisplay');
                input.select();
                input.setSelectionRange(0, 99999);
                navigator.clipboard.writeText(input.value).then(() => {
                    notifications.show('Enlace Copiado', 'Link listo para compartir.');
                });
            },

            updateServiceField(index, field, value) {
                if(this.currentConfig.servicios[index]) {
                    this.currentConfig.servicios[index][field] = value;
                }
            },

            addService() {
                const name = document.getElementById('newSrvName').value.trim();
                const price = document.getElementById('newSrvPrice').value.trim();
                const img = document.getElementById('newSrvImg').value.trim();
                
                if(!name) return alert("El nombre es obligatorio");
                
                this.currentConfig.servicios.push({ 
                    name, price, 
                    img: img || 'https://via.placeholder.com/300?text=Servicio' 
                });
                
                document.getElementById('newSrvName').value = '';
                document.getElementById('newSrvPrice').value = '';
                document.getElementById('newSrvImg').value = '';
                
                this.renderConfigForm();
            },

            removeService(index) {
                if(confirm("¿Eliminar este servicio?")) {
                    this.currentConfig.servicios.splice(index, 1);
                    this.renderConfigForm();
                }
            },

            async saveConfig() {
                this.currentConfig.nombre_salon = document.getElementById('cfgNombreSalon').value;
                this.currentConfig.nombre_encargada = document.getElementById('cfgEncargada').value;
                this.currentConfig.imagen_portada = document.getElementById('cfgPortada').value;

                const { error } = await supabaseClient.from('negocios').upsert({
                    codigo_negocio: this.code,
                    nombre_salon: this.currentConfig.nombre_salon,
                    nombre_encargada: this.currentConfig.nombre_encargada,
                    imagen_portada: this.currentConfig.imagen_portada,
                    servicios: this.currentConfig.servicios
                });

                if(error) {
                    alert("Error al guardar: " + error.message);
                } else {
                    notifications.show('Guardado', 'La configuración se actualizó correctamente.');
                }
            },

            // --- LÓGICA DE DATOS GENERALES ---
            async loadData() {
                const { data } = await supabaseClient.from('reservas').select('*').eq('codigo_negocio', this.code).order('created_at', { ascending: false });
                if(data) {
                    this.data = data;
                    this.renderList();
                    adminCalendar.init();
                    this.subscribe();
                }
                adminChat.init();
            },

            subscribe() {
                supabaseClient.channel('admin_res').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'reservas', filter: `codigo_negocio=eq.${this.code}` }, payload => {
                    this.data.unshift(payload.new);
                    this.renderList();
                    adminCalendar.render();
                    notifications.show('Nueva Reserva', `${payload.new.nombre} ha reservado.`, 'reserva');
                }).subscribe();
            },

            filter(status) {
                this.renderList(status);
            },

            renderList(filterStatus = 'todas') {
                const container = document.getElementById('bookingsList'); container.innerHTML = '';
                const filtered = filterStatus === 'todas' ? this.data : this.data.filter(r => r.estado === filterStatus);
                
                filtered.forEach(res => {
                    const statusClass = res.estado === 'confirmada' ? 'st-confirmada' : (res.estado === 'cancelada' ? 'st-cancelada' : 'st-pendiente');
                    let actions = '';
                    if(res.estado === 'pendiente') {
                        actions = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                            <div class="btn-action btn-reject" onclick="admin.updateStatus('${res.id}', 'cancelada')">Rechazar</div>
                            <div class="btn-action btn-approve" onclick="admin.updateStatus('${res.id}', 'confirmada')">Confirmar</div>
                        </div>`;
                    }
                    const card = document.createElement('div'); card.className = 'booking-card';
                    card.innerHTML = `<div class="b-header"><div><div style="font-weight:600; font-size:1.1rem">${res.nombre} ${res.apellido}</div><div style="color:var(--accent); font-size:0.9rem">${res.servicio}</div></div><span class="status-badge ${statusClass}">${res.estado}</span></div><div style="color:#ccc; font-size:0.9rem; margin-top:5px;"><i class="ph ph-calendar-blank"></i> ${new Date(res.fecha+'T00:00:00').toLocaleDateString()} &nbsp; <i class="ph ph-clock"></i> ${res.hora}</div>${actions}`;
                    container.appendChild(card);
                });
            },

            async updateStatus(id, st) {
                await supabaseClient.from('reservas').update({ estado: st }).eq('id', id);
                const item = this.data.find(r => r.id === id); if(item) item.estado = st;
                this.renderList(); adminCalendar.render();
            }
        };

        const adminCalendar = {
            date: new Date(), monthNames: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
            init() { this.render(); },
            render() {
                const year = this.date.getFullYear(), month = this.date.getMonth();
                document.getElementById('calMonthLabel').textContent = `${this.monthNames[month]} ${year}`;
                const grid = document.getElementById('calDaysGrid'); grid.innerHTML = '';
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                const confirmed = admin.data.filter(r => r.estado === 'confirmada').length;
                const pending = admin.data.filter(r => r.estado === 'pendiente').length;
                const total = confirmed + pending || 1;
                document.getElementById('cStatConfirmed').textContent = confirmed;
                document.getElementById('cStatPending').textContent = pending;
                document.getElementById('progConfirmed').style.width = `${(confirmed/total)*100}%`;
                document.getElementById('progPending').style.width = `${(pending/total)*100}%`;

                for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
                for(let i=1; i<=daysInMonth; i++) {
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const bookings = admin.data.filter(r => r.fecha === dateStr && r.estado !== 'cancelada');
                    const el = document.createElement('div'); el.className = 'cal-day';
                    if(bookings.length > 0) {
                        el.classList.add('has-event');
                        if(bookings.some(r => r.estado === 'pendiente')) el.classList.add('pending');
                        el.onclick = () => this.openModal(i, this.monthNames[month], bookings);
                    }
                    el.innerHTML = `<span>${i}</span><div class="cal-dot"></div>`;
                    grid.appendChild(el);
                }
            },
            changeMonth(d) { this.date.setMonth(this.date.getMonth()+d); this.render(); },
            openModal(day, month, bookings) {
                document.getElementById('modalDateTitle').textContent = `${day} de ${month}`;
                const list = document.getElementById('modalEventList'); list.innerHTML = '';
                bookings.forEach(b => {
                    const div = document.createElement('div');
                    div.style.cssText = "background:#222; padding:10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center";
                    div.innerHTML = `<div><div style="font-weight:bold; color:white;">${b.nombre}</div><div style="font-size:0.8rem; color:#888;">${b.servicio} - ${b.hora}</div></div><div style="width:8px; height:8px; border-radius:50%; background:${b.estado==='pendiente'?'#ffcc00':'#00E08F'}"></div>`;
                    list.appendChild(div);
                });
                document.getElementById('dateModal').style.display = 'flex';
            },
            closeModal() { document.getElementById('dateModal').style.display = 'none'; }
        };

        const adminChat = {
            activePhone: null, conversations: {},
            init() { 
                if(!admin.code) return;
                this.loadConversations();
                this.subscribe();
            },
            async loadConversations() {
                const { data } = await supabaseClient.from('mensajes').select('*').eq('codigo_negocio', admin.code).order('created_at', { ascending: true });
                if(data) {
                    this.conversations = {};
                    data.forEach(m => {
                        if(!this.conversations[m.telefono_cliente]) this.conversations[m.telefono_cliente] = { msgs: [], last: '', unread: false };
                        this.conversations[m.telefono_cliente].msgs.push(m);
                        this.conversations[m.telefono_cliente].last = m.contenido;
                        if(m.emisor === 'cliente' && !m.leido) this.conversations[m.telefono_cliente].unread = true;
                    });
                    this.renderList();
                }
            },
            subscribe() {
                supabaseClient.channel('chat_admin').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'mensajes', filter: `codigo_negocio=eq.${admin.code}` }, payload => {
                    const m = payload.new;
                    if(!this.conversations[m.telefono_cliente]) this.conversations[m.telefono_cliente] = { msgs: [], last: '', unread: false };
                    this.conversations[m.telefono_cliente].msgs.push(m);
                    this.conversations[m.telefono_cliente].last = m.contenido;
                    
                    if(m.emisor === 'cliente') {
                        if(this.activePhone === m.telefono_cliente) { this.renderBubble(m); this.scroll(); }
                        else { 
                            this.conversations[m.telefono_cliente].unread = true; 
                            document.getElementById('msgNotify').style.display = 'inline';
                            notifications.show('Mensaje Nuevo', `De: ${m.telefono_cliente}`, 'mensaje');
                        }
                    } else if(this.activePhone === m.telefono_cliente) { this.renderBubble(m); this.scroll(); }
                    
                    this.renderList();
                }).subscribe();
            },
            renderList() {
                const list = document.getElementById('inboxList'); list.innerHTML = '';
                Object.keys(this.conversations).forEach(phone => {
                    const chat = this.conversations[phone];
                    const div = document.createElement('div'); div.className = `chat-item ${this.activePhone === phone ? 'active' : ''}`;
                    const client = admin.data.find(c => c.telefono === phone);
                    const name = client ? `${client.nombre} ${client.apellido}` : phone;
                    div.innerHTML = `<div style="font-weight:bold; color:white; margin-bottom:4px;">${name}</div><div style="color:#888; font-size:0.85rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${chat.last}</div>${chat.unread?'<div style="width:8px; height:8px; background:var(--accent); border-radius:50%; position:absolute; right:15px; top:25px;"></div>':''}`;
                    div.onclick = () => this.open(phone, name);
                    list.appendChild(div);
                });
            },
            open(phone, name) {
                this.activePhone = phone;
                this.conversations[phone].unread = false;
                document.getElementById('msgNotify').style.display = 'none';
                this.renderList();
                
                const view = document.getElementById('adminChatView');
                if(window.innerWidth <= 768) { view.classList.add('active'); document.getElementById('chatBackBtn').style.display = 'block'; }
                
                document.getElementById('chatActiveUser').textContent = name;
                document.getElementById('chatFooterInput').style.display = 'flex';
                const body = document.getElementById('adminChatBody'); body.innerHTML = '';
                this.conversations[phone].msgs.forEach(m => this.renderBubble(m));
                this.scroll();
            },
            closeMobile() {
                document.getElementById('adminChatView').classList.remove('active');
                this.activePhone = null;
            },
            renderBubble(m) {
                const div = document.createElement('div'); div.className = `msg-bubble ${m.emisor}`;
                div.textContent = m.contenido;
                document.getElementById('adminChatBody').appendChild(div);
            },
            async send() {
                const inp = document.getElementById('adminChatInput');
                const txt = inp.value.trim();
                if(!txt || !this.activePhone) return;
                inp.value = '';
                await supabaseClient.from('mensajes').insert([{ codigo_negocio: admin.code, telefono_cliente: this.activePhone, emisor: 'admin', contenido: txt, leido: true }]);
            },
            scroll() { const b = document.getElementById('adminChatBody'); setTimeout(()=>b.scrollTop=b.scrollHeight,100); }
        };

        // --- SISTEMA DE NOTIFICACIONES PUSH (SW) ---
        
        // ** CLAVE VAPID PÚBLICA ACTUALIZADA **
        const VAPID_PUBLIC_KEY = 'BGnVsu2EOWLendskkjd3veXBygPmvnFh1rC6oYnUBWbV7K_610tJXvS5qAjN7bMw-ZEN20ZwgQNmyUKTRevf5qo';

        const pushService = {
            btn: document.getElementById('btn-notif-status'),
            swRegistration: null,

            async init() {
                if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                    this.btn.style.display = 'none';
                    return;
                }

                try {
                    // REGISTRO DEL SERVICE WORKER
                    this.swRegistration = await navigator.serviceWorker.register('sw.js');
                    this.updateBtnUI();
                } catch (error) {
                    console.error("SW Error:", error);
                }
            },

            async enable() {
                // 1. Pedir permiso al usuario
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    alert('Permiso denegado. Habilita las notificaciones en el navegador.');
                    return;
                }

                // 2. Suscribirse al PushManager usando tu clave VAPID
                try {
                    const subscription = await this.swRegistration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: this.urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                    });

                    // IMPORTANTE:
                    // AQUÍ ES DONDE DEBERÍAS GUARDAR "subscription" EN TU SUPABASE 
                    // PARA PODER ENVIAR MENSAJES LUEGO.
                    console.log("Suscripción Exitosa (JSON):", JSON.stringify(subscription));
                    
                    notifications.show('Notificaciones Activadas', 'Ahora recibirás alertas en este dispositivo.');
                    this.updateBtnUI();

                } catch (e) {
                    console.error("Error al suscribir:", e);
                    alert("Error técnico al suscribir. Revisa la consola (F12).");
                }
            },

            async updateBtnUI() {
                if(!this.swRegistration) return;
                const subscription = await this.swRegistration.pushManager.getSubscription();
                
                if (subscription) {
                    this.btn.innerHTML = '<i class="ph ph-bell"></i> Notificaciones Activas';
                    this.btn.classList.add('active');
                    this.btn.onclick = null; // Ya no hace nada si está activo
                } else {
                    this.btn.innerHTML = '<i class="ph ph-bell-slash"></i> Activar Notificaciones';
                    this.btn.classList.remove('active');
                    this.btn.onclick = () => this.enable();
                }
            },

            // Utilidad para convertir la clave VAPID
            urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            }
        };

        admin.init();
    </script>
</body>
</html>
