<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Glow Admin Portal</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link rel="manifest" href="manifest.json">

    <style>
        /* --- 1. VARIABLES & RESET IOS STYLE --- */
        :root {
            /* Palette iOS Light */
            --ios-bg: #F2F2F7;         
            --ios-card: #FFFFFF;       
            --ios-text: #000000;       
            --ios-text-sec: #8E8E93;   
            --ios-accent: #E000E0;     /* SE ACTUALIZARÁ DINÁMICAMENTE */
            --ios-blue: #007AFF;       
            --ios-gray-input: #E5E5EA; 
            --ios-border: rgba(0,0,0,0.05);
            
            /* Status Colors (Pastel) */
            --st-success-bg: #E0F8E5; --st-success-txt: #008f4c;
            --st-warn-bg: #FFF4CE;    --st-warn-txt: #B38600;
            --st-danger-bg: #FFE5E5;  --st-danger-txt: #D32F2F;

            /* UI Constants */
            --radius-l: 24px;
            --radius-m: 16px;
            --radius-s: 12px;
            --shadow-soft: 0 8px 30px rgba(0,0,0,0.04);
            --shadow-card: 0 2px 10px rgba(0,0,0,0.03);
            --nav-height: 85px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--ios-bg); 
            color: var(--ios-text); 
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
            height: 100vh; height: 100dvh; 
            overflow: hidden; 
            -webkit-font-smoothing: antialiased;
        }

        /* --- 2. LOGIN SCREEN (Clean & Minimal) --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--ios-card); z-index: 99999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            padding: 40px;
        }
        
        .brand-login { 
            font-family: 'Playfair Display', serif; font-size: 3.5rem; margin-bottom: 40px; 
            color: var(--ios-text); letter-spacing: -1px;
        }
        .brand-login span { color: var(--ios-accent); }

        .login-box { width: 100%; max-width: 320px; animation: slideUpFade 0.6s ease; }
        
        .input-ios {
            width: 100%; padding: 18px; 
            background: var(--ios-bg); border: none; 
            color: var(--ios-text); border-radius: var(--radius-m); 
            font-size: 1.1rem; outline: none; transition: transform 0.2s;
            text-align: center; font-weight: 600;
        }
        .input-ios:focus { background: #EBEBF0; transform: scale(1.02); }
        .input-ios::placeholder { color: #C7C7CC; font-weight: 400; }

        .btn-ios {
            width: 100%; padding: 18px; border-radius: 50px; border: none;
            font-weight: 700; cursor: pointer; font-size: 1rem; margin-top: 20px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .btn-primary { 
            background: var(--ios-text); color: white; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
        }
        .btn-primary:active { transform: scale(0.96); }

        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- 3. DASHBOARD LAYOUT (Full Screen + Bottom Nav) --- */
        #dashboard { 
            display: none; flex-direction: column; height: 100%; width: 100%;
            background: var(--ios-bg);
        }

        /* Header "Large Title" Style */
        .header-section {
            padding: 20px 25px; 
            padding-top: max(20px, env(safe-area-inset-top));
            background: var(--ios-bg);
            display: flex; justify-content: space-between; align-items: flex-end;
            position: sticky; top: 0; z-index: 50;
        }
        
        .header h2 { 
            font-family: 'Playfair Display', serif; font-size: 2.2rem; 
            color: var(--ios-text); margin-bottom: 5px; 
        }
        .code-badge { 
            font-size: 0.8rem; font-weight: 600; color: var(--ios-text-sec); 
            background: rgba(0,0,0,0.05); padding: 4px 10px; border-radius: 20px;
            display: inline-block;
        }

        /* Area de Notificaciones y Logout */
        .header-actions { display: flex; gap: 10px; }
        .icon-btn {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: var(--ios-card); color: var(--ios-text);
            box-shadow: var(--shadow-card); display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer; transition: 0.2s;
        }
        .icon-btn:active { transform: scale(0.9); }
        .icon-btn.active { background: var(--ios-accent); color: white; box-shadow: 0 5px 15px rgba(224, 0, 224, 0.4); }

        /* Contenedor Principal con Scroll */
        .content-scroll-area {
            flex: 1; overflow-y: auto; 
            padding: 0 20px; padding-bottom: calc(var(--nav-height) + 20px);
            scrollbar-width: none; /* Ocultar scrollbar */
        }
        .content-scroll-area::-webkit-scrollbar { display: none; }

        /* --- 4. BOTTOM NAVIGATION (Glassmorphism) --- */
        .nav-tabs {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: var(--nav-height);
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 1000;
        }

        .tab-btn {
            background: transparent; border: none; color: #C7C7CC;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            font-size: 0.75rem; font-weight: 600; cursor: pointer;
            width: 60px; transition: color 0.3s; position: relative;
        }
        .tab-btn i { font-size: 1.6rem; transition: transform 0.3s; }
        
        .tab-btn.active { color: var(--ios-accent); }
        .tab-btn.active i { transform: translateY(-2px); }
        
        /* Indicador de mensaje nuevo (punto rojo) */
        #msgNotify {
            position: absolute; top: 0px; right: 15px; 
            width: 10px; height: 10px; background: #FF3B30; 
            border-radius: 50%; border: 2px solid white;
        }

        /* --- 5. SECCIONES Y COMPONENTES --- */
        
        /* Views Animation */
        .view-section { display: none; animation: fadeInView 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .view-section.active { display: block; }
        @keyframes fadeInView { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* Tarjetas Generales */
        .card-box {
            background: var(--ios-card); border-radius: var(--radius-l);
            padding: 25px; margin-bottom: 20px; box-shadow: var(--shadow-soft);
        }

        /* CALENDARIO ESTILO IOS */
        .calendar-stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card {
            background: var(--ios-card); padding: 20px; border-radius: var(--radius-m);
            box-shadow: var(--shadow-card); display: flex; flex-direction: column; align-items: flex-start;
        }
        .stat-num { font-size: 2rem; font-weight: 700; font-family: 'Playfair Display'; line-height: 1; margin-bottom: 5px; }
        .stat-label { font-size: 0.8rem; color: var(--ios-text-sec); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .calendar-frame { background: var(--ios-card); border-radius: var(--radius-l); padding: 20px; box-shadow: var(--shadow-soft); }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .cal-nav-btn { color: var(--ios-accent); background: none; border: none; font-size: 1.4rem; padding: 5px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .cal-day-name { font-size: 0.75rem; color: #C7C7CC; font-weight: 700; margin-bottom: 10px; }
        
        .cal-day { 
            aspect-ratio: 1; border-radius: 50%; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; font-size: 0.95rem; font-weight: 500;
            position: relative; transition: 0.2s; cursor: pointer;
        }
        .cal-day.today { background: var(--ios-text); color: white; font-weight: 700; }
        .cal-day:active { transform: scale(0.9); background: #f0f0f0; }
        .cal-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--ios-accent); margin-top: 2px; opacity: 0; }
        .cal-day.has-event .cal-dot { opacity: 1; }
        .cal-day.has-event.pending .cal-dot { background: #FF9500; }

        /* LISTA DE RESERVAS */
        .bookings-list { display: flex; flex-direction: column; gap: 15px; }
        .booking-card {
            background: var(--ios-card); padding: 20px; border-radius: var(--radius-m);
            box-shadow: var(--shadow-card); position: relative; overflow: hidden;
            border: 1px solid rgba(0,0,0,0.02);
        }
        .booking-card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px;
        }
        .st-pendiente .booking-card::before { background: #FF9500; }
        .st-confirmada .booking-card::before { background: #34C759; }
        .st-cancelada .booking-card::before { background: #FF3B30; }

        .b-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .b-name { font-weight: 700; font-size: 1.1rem; color: var(--ios-text); }
        .b-service { color: var(--ios-accent); font-size: 0.9rem; font-weight: 600; margin-top: 2px; }
        
        .status-badge { 
            padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; 
        }
        .st-pendiente { background: var(--st-warn-bg); color: var(--st-warn-txt); }
        .st-confirmada { background: var(--st-success-bg); color: var(--st-success-txt); }
        .st-cancelada { background: var(--st-danger-bg); color: var(--st-danger-txt); }

        .action-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; border-top: 1px solid #f0f0f0; padding-top: 15px; }
        .btn-action {
            padding: 10px; border-radius: 10px; font-size: 0.9rem; font-weight: 600; 
            text-align: center; cursor: pointer; transition: 0.2s;
        }
        .btn-reject { color: #FF3B30; background: rgba(255, 59, 48, 0.1); }
        .btn-approve { color: #34C759; background: rgba(52, 199, 89, 0.1); }
        .btn-action:active { transform: scale(0.97); }

        /* CONFIGURACIÓN */
        .settings-group { margin-bottom: 25px; }
        .settings-title { 
            font-size: 0.85rem; color: var(--ios-text-sec); text-transform: uppercase; 
            margin-bottom: 8px; margin-left: 15px; font-weight: 600;
        }
        .settings-box { 
            background: var(--ios-card); border-radius: var(--radius-m); 
            overflow: hidden; box-shadow: var(--shadow-card); 
        }
        .setting-item { 
            padding: 15px 20px; border-bottom: 1px solid #F2F2F7; 
            display: flex; flex-direction: column; gap: 8px; 
        }
        .setting-item:last-child { border-bottom: none; }
        
        .form-input-clean {
            width: 100%; border: none; font-size: 1rem; color: var(--ios-text); 
            font-family: inherit; padding: 5px 0; outline: none; background: transparent;
        }
        .form-input-clean::placeholder { color: #C7C7CC; }

        /* Color Input */
        .color-picker-wrapper {
            display: flex; align-items: center; justify-content: space-between; width: 100%;
        }
        .color-input-native {
            border: none; width: 40px; height: 40px; cursor: pointer; background: none;
        }
        
        .srv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; padding: 15px; }
        .srv-item { 
            position: relative; border-radius: 12px; overflow: hidden; aspect-ratio: 1; 
            background: #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .srv-item img { width: 100%; height: 100%; object-fit: cover; }
        .srv-del-btn {
            position: absolute; top: 5px; right: 5px; background: rgba(255,255,255,0.9); 
            color: #FF3B30; border-radius: 50%; width: 24px; height: 24px; border: none;
            display: flex; align-items: center; justify-content: center;
        }
        .srv-inputs { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.9); padding: 5px; }
        .srv-input-mini { 
            width: 100%; background: transparent; border: none; font-size: 0.75rem; 
            color: black; font-weight: 600; text-align: center; display: block;
        }

        /* UPLOAD STYLES */
        .upload-label {
            display: inline-block; background: var(--ios-text); color: white;
            padding: 8px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;
            cursor: pointer; margin-top: 5px; width: fit-content;
        }
        .upload-input { display: none; }
        .profile-preview {
            width: 70px; height: 70px; border-radius: 50%; object-fit: cover;
            border: 2px solid #F2F2F7; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            background: #eee;
        }

        /* CHAT (iMessage Style) */
        .chat-layout { height: calc(100vh - var(--nav-height) - 100px); display: flex; flex-direction: column; }
        .chat-list { display: flex; flex-direction: column; background: var(--ios-bg); gap: 1px; }
        .chat-item {
            background: var(--ios-card); padding: 15px 20px; display: flex; align-items: center; gap: 15px; cursor: pointer;
        }
        .chat-item:active { background: #E5E5EA; }
        .chat-avatar {
            width: 50px; height: 50px; border-radius: 50%; background: #E5E5EA; color: #8E8E93;
            display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem;
        }
        .chat-info { flex: 1; min-width: 0; }
        .chat-name { font-weight: 700; margin-bottom: 4px; color: var(--ios-text); }
        .chat-preview { color: var(--ios-text-sec); font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-unread-dot { width: 12px; height: 12px; background: var(--ios-blue); border-radius: 50%; }

        /* Chat View (Slide Over) */
        .chat-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--ios-card); z-index: 2000;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .chat-view.active { transform: translateX(0); }
        
        .cv-header {
            padding: 15px; padding-top: max(15px, env(safe-area-inset-top));
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px;
        }
        .cv-body { flex: 1; overflow-y: auto; padding: 20px; background: white; display: flex; flex-direction: column; gap: 8px; }
        
        .msg-bubble { max-width: 75%; padding: 10px 16px; border-radius: 18px; font-size: 1rem; line-height: 1.4; position: relative; }
        .msg-bubble.admin { align-self: flex-end; background: var(--ios-blue); color: white; border-bottom-right-radius: 4px; }
        .msg-bubble.cliente { align-self: flex-start; background: #E5E5EA; color: black; border-bottom-left-radius: 4px; }

        .cv-footer {
            padding: 10px 15px; padding-bottom: max(10px, env(safe-area-inset-bottom));
            background: #F9F9F9; border-top: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px;
        }

        /* --- 6. TOAST NOTIFICATIONS --- */
        #toast-container { position: fixed; top: 50px; left: 50%; transform: translateX(-50%); z-index: 10000; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 30px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 15px;
            opacity: 0; transform: translateY(-20px); transition: 0.4s;
        }
        .toast.active { opacity: 1; transform: translateY(0); }

        /* MODAL */
        #dateModal {
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>
    <audio id="notifySound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div id="login-screen">
        <div class="brand-login">GLOW<span>.</span></div>
        <div class="login-box">
            <input type="text" id="businessCodeInput" class="input-ios" placeholder="CÓDIGO DE NEGOCIO" maxlength="20">
            <button class="btn-ios btn-primary" onclick="admin.login()">Ingresar</button>
            <p id="loginError" style="color:var(--st-danger-txt); margin-top:15px; display:none; text-align:center;">Código requerido</p>
        </div>
    </div>

    <div id="dashboard">
        
        <div class="header-section">
            <div class="header">
                <h2 id="dashTitle">Resumen</h2>
                <div class="code-badge" id="dashCodeDisplay">--</div>
            </div>
            <div class="header-actions">
                <button class="icon-btn" id="btn-notif-status" onclick="pushService.enable()">
                    <i class="ph ph-bell"></i>
                </button>
                <button class="icon-btn" onclick="admin.logout()">
                    <i class="ph ph-sign-out"></i>
                </button>
            </div>
        </div>

        <div class="content-scroll-area">
            
            <div id="view-calendar" class="view-section active">
                <div class="calendar-stats-container">
                    <div class="stat-card">
                        <span class="stat-num" id="cStatConfirmed" style="color:var(--st-success-txt)">0</span>
                        <span class="stat-label">Confirmadas</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-num" id="cStatPending" style="color:var(--st-warn-txt)">0</span>
                        <span class="stat-label">Pendientes</span>
                    </div>
                </div>

                <div class="calendar-frame">
                    <div class="cal-header">
                        <button class="cal-nav-btn" onclick="adminCalendar.changeMonth(-1)"><i class="ph ph-caret-left"></i></button>
                        <h3 id="calMonthLabel" style="font-family:'Playfair Display'; margin:0;">--</h3>
                        <button class="cal-nav-btn" onclick="adminCalendar.changeMonth(1)"><i class="ph ph-caret-right"></i></button>
                    </div>
                    <div class="cal-grid">
                        <div class="cal-day-name">D</div><div class="cal-day-name">L</div>
                        <div class="cal-day-name">M</div><div class="cal-day-name">M</div>
                        <div class="cal-day-name">J</div><div class="cal-day-name">V</div>
                        <div class="cal-day-name">S</div>
                    </div>
                    <div class="cal-grid" id="calDaysGrid"></div>
                </div>
                <div style="height:20px;"></div>
            </div>

            <div id="view-reservas" class="view-section">
                
                <div style="display:flex; gap:10px; margin-bottom:20px; overflow-x:auto; padding-bottom:5px;">
                    <button onclick="admin.filter('todas')" class="status-badge" style="background:var(--ios-text); color:white; border:none; cursor:pointer;">Todas</button>
                    <button onclick="admin.filter('pendiente')" class="status-badge" style="background:var(--st-warn-bg); color:var(--st-warn-txt); border:none; cursor:pointer;">Pendientes</button>
                </div>
                
                <div class="bookings-list" id="bookingsList"></div>
            </div>

            <div id="view-mensajes" class="view-section">
                <h3 style="margin-bottom:15px; font-family:'Playfair Display'; font-size:1.5rem;">Bandeja de Entrada</h3>
                <div class="chat-list" id="inboxList" style="border-radius:20px; overflow:hidden;"></div>
            </div>

            <div id="view-config" class="view-section">
                
                <div class="settings-group">
                    <div class="settings-title">Identidad del Negocio</div>
                    <div class="settings-box">
                        <div class="setting-item" style="flex-direction:row; align-items:center; justify-content:space-between;">
                            <div style="display:flex; align-items:center; gap:15px;">
                                <img id="previewLogo" class="profile-preview" src="https://via.placeholder.com/70">
                                <div>
                                    <label style="font-weight:600; font-size:0.95rem;">Foto de Perfil</label>
                                    <p style="font-size:0.75rem; color:#888;">Visible en App y WhatsApp</p>
                                </div>
                            </div>
                            <div>
                                <label class="upload-label">
                                    Subir Foto
                                    <input type="file" class="upload-input" accept="image/*" onchange="admin.uploadImage(this, 'cfgLogo')">
                                </label>
                                <input type="hidden" id="cfgLogo">
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="color-picker-wrapper">
                                <div>
                                    <label style="font-weight:600; font-size:0.95rem;">Color de Marca</label>
                                    <p style="font-size:0.75rem; color:#888;">Personaliza el tema</p>
                                </div>
                                <input type="color" id="cfgColor" class="color-input-native" value="#E000E0" onchange="admin.applyTheme(this.value)">
                            </div>
                        </div>

                    </div>
                </div>

                <div class="settings-group">
                    <div class="settings-title">Enlace Público</div>
                    <div class="settings-box">
                        <div class="setting-item" style="flex-direction:row; justify-content:space-between; align-items:center;">
                            <input type="text" id="publicLinkDisplay" readonly style="border:none; background:transparent; color:var(--ios-blue); width:80%; outline:none;" onclick="this.select()">
                            <button onclick="admin.copyLink()" style="background:none; border:none; color:var(--ios-text);"><i class="ph ph-copy" style="font-size:1.2rem;"></i></button>
                        </div>
                        <div class="setting-item">
                            <a href="#" id="openLinkBtn" target="_blank" style="color:var(--ios-text); text-decoration:none; font-size:0.9rem; font-weight:600;">Ver página pública <i class="ph ph-arrow-right"></i></a>
                        </div>
                    </div>
                </div>

                <div class="settings-group">
                    <div class="settings-title">Personalización</div>
                    <div class="settings-box">
                        <div class="setting-item">
                            <label style="font-size:0.8rem; color:#888;">Nombre del Salón</label>
                            <input type="text" class="form-input-clean" id="cfgNombreSalon" placeholder="Ej: Glow Spa">
                        </div>
                        <div class="setting-item">
                            <label style="font-size:0.8rem; color:#888;">Encargada</label>
                            <input type="text" class="form-input-clean" id="cfgEncargada" placeholder="Ej: Sofía">
                        </div>
                        <div class="setting-item">
                            <label style="font-size:0.8rem; color:#888;">Portada (Fondo)</label>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <input type="text" class="form-input-clean" id="cfgPortada" placeholder="URL Imagen" style="flex:1;">
                                <label class="upload-label">
                                    <i class="ph ph-upload-simple"></i>
                                    <input type="file" class="upload-input" accept="image/*" onchange="admin.uploadImage(this, 'cfgPortada')">
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-group">
                    <div class="settings-title">Servicios</div>
                    <div class="settings-box">
                        <div class="srv-grid" id="cfgServicesList"></div>
                        <div class="setting-item" style="background:#FAFAFA;">
                            <p style="font-weight:600; margin-bottom:10px;">Nuevo Servicio</p>
                            <input type="text" class="form-input-clean" id="newSrvName" placeholder="Nombre (Ej: Manicure)" style="border-bottom:1px solid #ddd; margin-bottom:5px;">
                            <input type="text" class="form-input-clean" id="newSrvPrice" placeholder="Precio (Ej: $20)" style="border-bottom:1px solid #ddd; margin-bottom:5px;">
                            
                            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                                <input type="text" class="form-input-clean" id="newSrvImg" placeholder="URL Imagen" style="flex:1;">
                                <label class="upload-label" style="padding: 5px 10px; margin:0;">
                                    <i class="ph ph-upload-simple"></i>
                                    <input type="file" class="upload-input" accept="image/*" onchange="admin.uploadImage(this, 'newSrvImg')">
                                </label>
                            </div>

                            <button onclick="admin.addService()" style="background:var(--ios-text); color:white; border:none; padding:10px; border-radius:10px; width:100%; font-weight:600;">Agregar</button>
                        </div>
                    </div>
                </div>

                <button class="btn-ios btn-primary" onclick="admin.saveConfig()" style="position:sticky; bottom:20px; z-index:10;">
                    Guardar Cambios
                </button>
            </div>

        </div> <div class="nav-tabs">
            <button class="tab-btn active" onclick="admin.switchTab('calendar', this)">
                <i class="ph ph-calendar-blank"></i>
                Calendario
            </button>
            <button class="tab-btn" onclick="admin.switchTab('reservas', this)">
                <i class="ph ph-list-dashes"></i>
                Reservas
            </button>
            <button class="tab-btn" onclick="admin.switchTab('mensajes', this)">
                <span id="msgNotify" style="display:none;"></span>
                <i class="ph ph-chat-circle-text"></i>
                Mensajes
            </button>
            <button class="tab-btn" onclick="admin.switchTab('config', this)">
                <i class="ph ph-gear"></i>
                Ajustes
            </button>
        </div>

    </div>

    <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:2000; display:none; align-items:center; justify-content:center;" id="dateModal" onclick="if(event.target === this) adminCalendar.closeModal()">
        <div style="background:white; padding:25px; border-radius:30px; width:85%; max-width:350px; box-shadow:0 20px 50px rgba(0,0,0,0.2); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
            <h2 id="modalDateTitle" style="font-family:'Playfair Display'; margin-bottom:15px; font-size:1.8rem;">--</h2>
            <div id="modalEventList" style="margin-top:10px; display:flex; flex-direction:column; gap:10px; max-height:300px; overflow-y:auto;"></div>
            <button onclick="adminCalendar.closeModal()" style="margin-top:20px; background:#F2F2F7; color:black; width:100%; padding:15px; border-radius:15px; border:none; font-weight:600;">Cerrar</button>
        </div>
    </div>
    <style>@keyframes popIn { from{transform:scale(0.8); opacity:0;} to{transform:scale(1); opacity:1;} }</style>

    <div class="chat-view" id="adminChatView">
        <div class="cv-header">
            <button onclick="adminChat.closeMobile()" style="background:none; border:none; font-size:1.5rem; color:var(--ios-blue); display:flex; align-items:center;">
                <i class="ph ph-caret-left"></i> Atrás
            </button>
            <div style="font-weight:700; font-size:1.1rem;" id="chatActiveUser">Chat</div>
        </div>
        <div class="cv-body" id="adminChatBody"></div>
        <div class="cv-footer" id="chatFooterInput" style="display:none;">
            <input type="text" id="adminChatInput" placeholder="iMessage..." style="background:white; border:1px solid #ddd; padding:10px 15px; border-radius:20px; flex:1; outline:none; font-size:1rem;" onkeypress="if(event.key === 'Enter') adminChat.send()">
            <button onclick="adminChat.send()" style="width:35px; height:35px; border-radius:50%; background:var(--ios-blue); border:none; color:white; display:flex; align-items:center; justify-content:center;"><i class="ph ph-arrow-up" style="font-weight:bold;"></i></button>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN SUPABASE
       const SUPABASE_URL = 'https://chpzkhuvfstmmljozpjc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNocHpraHV2ZnN0bW1sam96cGpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQzMzksImV4cCI6MjA4NDM0MDMzOX0.uWRs0xB68ltUVEJPICFuS9vYCmDN06KTUfgbS_4W9WU';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // DEFAULT DEMO DATA
        const DEMO_CONFIG = {
            nombre_salon: 'GLOW',
            nombre_encargada: 'Sofía Hernández',
            imagen_portada: 'https://i.ibb.co/67C1hcrb/1767558273844.png',
            logo_salon: 'https://i.ibb.co/99LsSW6N/Glow-20260112-140827-0000.png',
            theme_color: '#E000E0', // Default Fuchsia
            servicios: [
                { name: 'Corte y Secado', price: '$20', img: 'https://i.ibb.co/MDjWPmnP/1768612232066.png' },
                { name: 'Color y Mechas', price: '$50', img: 'https://i.ibb.co/HfSxF2BS/1768649929059.png' },
                { name: 'Manicure', price: '$15', img: 'https://i.ibb.co/HT95Xhqc/1768612130852.png' }
            ]
        };

        const notifications = {
            show(title, message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'toast';
                
                // Icono según tipo
                let icon = 'ph-info';
                if(type === 'reserva') icon = 'ph-calendar-check';
                if(type === 'mensaje') icon = 'ph-chat-circle-text';
                
                toast.innerHTML = `<i class="ph ${icon}" style="font-size:1.5rem; color:var(--ios-text)"></i><div><h4 style="margin:0; font-size:0.9rem; font-weight:700;">${title}</h4><p style="margin:0; font-size:0.8rem; color:#666">${message}</p></div>`;
                container.appendChild(toast);
                document.getElementById('notifySound').play().catch(()=>{});
                setTimeout(()=>toast.classList.add('active'),10);
                setTimeout(()=>{ toast.classList.remove('active'); setTimeout(()=>toast.remove(),400); }, 5000);
            }
        };

        const admin = {
            code: null, data: [], currentConfig: {...DEMO_CONFIG},
            
            init() {
                const storedCode = localStorage.getItem('glowAdminCode');
                if(storedCode) {
                    document.getElementById('businessCodeInput').value = storedCode;
                    this.login();
                }
            },

            async login() {
                const val = document.getElementById('businessCodeInput').value.trim().toUpperCase();
                if(!val) return;
                this.code = val;
                localStorage.setItem('glowAdminCode', val);
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                document.getElementById('dashCodeDisplay').textContent = `${this.code}`;
                
                this.loadData();
                this.loadConfig();
                
                pushService.init(); 
            },

            logout() { localStorage.removeItem('glowAdminCode'); location.reload(); },

            switchTab(tabName, btn) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                if(btn) btn.classList.add('active');
                
                // Animar salida
                const activeSection = document.querySelector('.view-section.active');
                if(activeSection) activeSection.classList.remove('active');
                
                // Animar entrada
                document.getElementById(`view-${tabName}`).classList.add('active');
                
                // Titulo dinámico
                const titles = { 'calendar': 'Calendario', 'reservas': 'Reservas', 'mensajes': 'Mensajes', 'config': 'Ajustes' };
                document.getElementById('dashTitle').textContent = titles[tabName];
            },

            applyTheme(colorHex) {
                // Actualiza visualmente la interfaz del admin
                document.documentElement.style.setProperty('--ios-accent', colorHex);
                // Actualizar input por si fue llamado externamente
                const input = document.getElementById('cfgColor');
                if(input && input.value !== colorHex) input.value = colorHex;
            },

            async loadConfig() {
                const { data } = await supabaseClient.from('negocios').select('*').eq('codigo_negocio', this.code).single();
                if(data) {
                    this.currentConfig = {
                        nombre_salon: data.nombre_salon || DEMO_CONFIG.nombre_salon,
                        nombre_encargada: data.nombre_encargada || DEMO_CONFIG.nombre_encargada,
                        imagen_portada: data.imagen_portada || DEMO_CONFIG.imagen_portada,
                        logo_salon: data.logo_salon || DEMO_CONFIG.logo_salon,
                        servicios: data.servicios || DEMO_CONFIG.servicios,
                        theme_color: data.theme_color || DEMO_CONFIG.theme_color
                    };
                }
                // Aplicar el tema cargado
                this.applyTheme(this.currentConfig.theme_color);
                this.renderConfigForm();
            },

            renderConfigForm() {
                const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                const publicUrl = `${baseUrl}/reserva/${this.code}`;
                
                document.getElementById('publicLinkDisplay').value = publicUrl;
                document.getElementById('openLinkBtn').href = publicUrl;

                document.getElementById('cfgNombreSalon').value = this.currentConfig.nombre_salon;
                document.getElementById('cfgEncargada').value = this.currentConfig.nombre_encargada;
                document.getElementById('cfgPortada').value = this.currentConfig.imagen_portada;
                document.getElementById('cfgLogo').value = this.currentConfig.logo_salon;
                
                // Set color
                document.getElementById('cfgColor').value = this.currentConfig.theme_color;
                
                // Previsualización del Logo
                document.getElementById('previewLogo').src = this.currentConfig.logo_salon;
                
                const list = document.getElementById('cfgServicesList');
                list.innerHTML = '';
                this.currentConfig.servicios.forEach((srv, idx) => {
                    const div = document.createElement('div'); div.className = 'srv-item';
                    div.innerHTML = `
                        <button class="srv-del-btn" onclick="admin.removeService(${idx})"><i class="ph ph-trash"></i></button>
                        <img src="${srv.img}" onerror="this.src='https://via.placeholder.com/150'">
                        <div class="srv-inputs">
                            <input type="text" class="srv-input-mini" value="${srv.name}" onchange="admin.updateServiceField(${idx}, 'name', this.value)">
                            <input type="text" class="srv-input-mini" style="color:var(--ios-accent)" value="${srv.price || ''}" onchange="admin.updateServiceField(${idx}, 'price', this.value)">
                        </div>
                    `;
                    list.appendChild(div);
                });
            },

            copyLink() {
                const input = document.getElementById('publicLinkDisplay');
                input.select();
                input.setSelectionRange(0, 99999);
                navigator.clipboard.writeText(input.value).then(() => {
                    notifications.show('Enlace Copiado', 'Listo para compartir.');
                });
            },

            // --- FUNCIÓN DE SUBIDA DE IMÁGENES ---
            async uploadImage(input, targetInputId) {
                const file = input.files[0];
                if (!file) return;

                // Feedback visual simple en el label
                const label = input.parentElement;
                
                try {
                    notifications.show('Subiendo...', 'Por favor espera.', 'info');

                    const fileName = `${this.code}/${Date.now()}_${file.name.replace(/\s/g, '_')}`;
                    
                    // Subir al bucket 'glow_files'
                    const { data, error } = await supabaseClient.storage
                        .from('glow_files')
                        .upload(fileName, file);

                    if (error) throw error;

                    // Obtener URL Pública
                    const { data: urlData } = supabaseClient.storage
                        .from('glow_files')
                        .getPublicUrl(fileName);

                    const publicUrl = urlData.publicUrl;

                    // Actualizar input objetivo
                    document.getElementById(targetInputId).value = publicUrl;

                    // Si es el logo, actualizar preview inmediatamente
                    if(targetInputId === 'cfgLogo') {
                        document.getElementById('previewLogo').src = publicUrl;
                    }
                    
                    notifications.show('Éxito', 'Imagen subida correctamente.');

                } catch (error) {
                    console.error('Error subiendo imagen:', error);
                    alert('Error subiendo imagen: ' + error.message);
                }
            },
            // -------------------------------------

            updateServiceField(index, field, value) {
                if(this.currentConfig.servicios[index]) {
                    this.currentConfig.servicios[index][field] = value;
                }
            },

            addService() {
                const name = document.getElementById('newSrvName').value.trim();
                const price = document.getElementById('newSrvPrice').value.trim();
                const img = document.getElementById('newSrvImg').value.trim();
                
                if(!name) return alert("El nombre es obligatorio");
                
                this.currentConfig.servicios.push({ 
                    name, price, 
                    img: img || 'https://via.placeholder.com/300?text=Servicio' 
                });
                
                document.getElementById('newSrvName').value = '';
                document.getElementById('newSrvPrice').value = '';
                document.getElementById('newSrvImg').value = '';
                
                this.renderConfigForm();
            },

            removeService(index) {
                if(confirm("¿Eliminar este servicio?")) {
                    this.currentConfig.servicios.splice(index, 1);
                    this.renderConfigForm();
                }
            },

            async saveConfig() {
                this.currentConfig.nombre_salon = document.getElementById('cfgNombreSalon').value;
                this.currentConfig.nombre_encargada = document.getElementById('cfgEncargada').value;
                this.currentConfig.imagen_portada = document.getElementById('cfgPortada').value;
                this.currentConfig.logo_salon = document.getElementById('cfgLogo').value;
                this.currentConfig.theme_color = document.getElementById('cfgColor').value; // Guardar Color

                const { error } = await supabaseClient.from('negocios').upsert({
                    codigo_negocio: this.code,
                    nombre_salon: this.currentConfig.nombre_salon,
                    nombre_encargada: this.currentConfig.nombre_encargada,
                    imagen_portada: this.currentConfig.imagen_portada,
                    logo_salon: this.currentConfig.logo_salon,
                    servicios: this.currentConfig.servicios,
                    theme_color: this.currentConfig.theme_color
                }, { onConflict: 'codigo_negocio' });

                if(error) {
                    alert("Error al guardar: " + error.message);
                } else {
                    notifications.show('Guardado', 'Configuración actualizada.');
                }
            },

            async loadData() {
                const { data } = await supabaseClient.from('reservas').select('*').eq('codigo_negocio', this.code).order('created_at', { ascending: false });
                if(data) {
                    this.data = data;
                    this.renderList();
                    adminCalendar.init();
                    this.subscribe();
                }
                adminChat.init();
            },

            subscribe() {
                supabaseClient.channel('admin_res').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'reservas', filter: `codigo_negocio=eq.${this.code}` }, payload => {
                    this.data.unshift(payload.new);
                    this.renderList();
                    adminCalendar.render();
                    notifications.show('Nueva Reserva', `${payload.new.nombre} ha reservado.`, 'reserva');
                }).subscribe();
            },

            filter(status) {
                this.renderList(status);
            },

            renderList(filterStatus = 'todas') {
                const container = document.getElementById('bookingsList'); container.innerHTML = '';
                const filtered = filterStatus === 'todas' ? this.data : this.data.filter(r => r.estado === filterStatus);
                
                if(filtered.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:#ccc; margin-top:20px;">No hay reservas</div>';
                    return;
                }

                filtered.forEach(res => {
                    const statusClass = res.estado === 'confirmada' ? 'st-confirmada' : (res.estado === 'cancelada' ? 'st-cancelada' : 'st-pendiente');
                    let actions = '';
                    if(res.estado === 'pendiente') {
                        actions = `<div class="action-row">
                            <div class="btn-action btn-reject" onclick="admin.updateStatus('${res.id}', 'cancelada')">Rechazar</div>
                            <div class="btn-action btn-approve" onclick="admin.updateStatus('${res.id}', 'confirmada')">Aceptar</div>
                        </div>`;
                    }
                    const card = document.createElement('div'); card.className = `booking-card ${statusClass}`;
                    card.innerHTML = `<div class="b-header"><div><div class="b-name">${res.nombre} ${res.apellido}</div><div class="b-service">${res.servicio}</div></div><span class="status-badge ${statusClass}">${res.estado}</span></div><div style="color:#666; font-size:0.9rem; margin-top:5px;"><i class="ph ph-calendar-blank"></i> ${new Date(res.fecha+'T00:00:00').toLocaleDateString()} &nbsp; • &nbsp; <i class="ph ph-clock"></i> ${res.hora}</div>${actions}`;
                    container.appendChild(card);
                });
            },

            async updateStatus(id, st) {
                await supabaseClient.from('reservas').update({ estado: st }).eq('id', id);
                const item = this.data.find(r => r.id === id); if(item) item.estado = st;
                this.renderList(); adminCalendar.render();
            }
        };

        const adminCalendar = {
            date: new Date(), monthNames: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
            init() { this.render(); },
            render() {
                const year = this.date.getFullYear(), month = this.date.getMonth();
                document.getElementById('calMonthLabel').textContent = `${this.monthNames[month]} ${year}`;
                const grid = document.getElementById('calDaysGrid'); grid.innerHTML = '';
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                const confirmed = admin.data.filter(r => r.estado === 'confirmada').length;
                const pending = admin.data.filter(r => r.estado === 'pendiente').length;
                
                document.getElementById('cStatConfirmed').textContent = confirmed;
                document.getElementById('cStatPending').textContent = pending;

                const today = new Date();

                for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
                for(let i=1; i<=daysInMonth; i++) {
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const bookings = admin.data.filter(r => r.fecha === dateStr && r.estado !== 'cancelada');
                    const el = document.createElement('div'); el.className = 'cal-day';
                    
                    if(year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) {
                        el.classList.add('today');
                    }

                    if(bookings.length > 0) {
                        el.classList.add('has-event');
                        if(bookings.some(r => r.estado === 'pendiente')) el.classList.add('pending');
                        el.onclick = () => this.openModal(i, this.monthNames[month], bookings);
                    } else {
                        el.innerHTML = `<span>${i}</span>`;
                    }
                    
                    if(bookings.length > 0) el.innerHTML = `<span>${i}</span><div class="cal-dot"></div>`;
                    
                    grid.appendChild(el);
                }
            },
            changeMonth(d) { this.date.setMonth(this.date.getMonth()+d); this.render(); },
            openModal(day, month, bookings) {
                document.getElementById('modalDateTitle').textContent = `${day} de ${month}`;
                const list = document.getElementById('modalEventList'); list.innerHTML = '';
                bookings.forEach(b => {
                    const div = document.createElement('div');
                    div.style.cssText = "background:#F9F9F9; padding:15px; border-radius:15px; display:flex; justify-content:space-between; align-items:center; border:1px solid #eee;";
                    div.innerHTML = `<div><div style="font-weight:700; font-size:1rem;">${b.nombre}</div><div style="font-size:0.85rem; color:#666;">${b.servicio} - ${b.hora}</div></div><div style="padding:4px 8px; border-radius:10px; font-size:0.7rem; font-weight:bold; text-transform:uppercase; background:${b.estado==='pendiente'?'#FFF4CE':'#E0F8E5'}; color:${b.estado==='pendiente'?'#B38600':'#008f4c'}">${b.estado.substring(0,4)}</div>`;
                    list.appendChild(div);
                });
                document.getElementById('dateModal').style.display = 'flex';
            },
            closeModal() { document.getElementById('dateModal').style.display = 'none'; }
        };

        const adminChat = {
            activePhone: null, conversations: {},
            init() { 
                if(!admin.code) return;
                this.loadConversations();
                this.subscribe();
            },
            async loadConversations() {
                const { data } = await supabaseClient.from('mensajes').select('*').eq('codigo_negocio', admin.code).order('created_at', { ascending: true });
                if(data) {
                    this.conversations = {};
                    data.forEach(m => {
                        if(!this.conversations[m.telefono_cliente]) this.conversations[m.telefono_cliente] = { msgs: [], last: '', unread: false };
                        this.conversations[m.telefono_cliente].msgs.push(m);
                        this.conversations[m.telefono_cliente].last = m.contenido;
                        if(m.emisor === 'cliente' && !m.leido) this.conversations[m.telefono_cliente].unread = true;
                    });
                    this.renderList();
                }
            },
            subscribe() {
                supabaseClient.channel('chat_admin').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'mensajes', filter: `codigo_negocio=eq.${admin.code}` }, payload => {
                    const m = payload.new;
                    if(!this.conversations[m.telefono_cliente]) this.conversations[m.telefono_cliente] = { msgs: [], last: '', unread: false };
                    this.conversations[m.telefono_cliente].msgs.push(m);
                    this.conversations[m.telefono_cliente].last = m.contenido;
                    
                    if(m.emisor === 'cliente') {
                        if(this.activePhone === m.telefono_cliente) { this.renderBubble(m); this.scroll(); }
                        else { 
                            this.conversations[m.telefono_cliente].unread = true; 
                            document.getElementById('msgNotify').style.display = 'block';
                            notifications.show('Mensaje Nuevo', `${m.telefono_cliente}`, 'mensaje');
                        }
                    } else if(this.activePhone === m.telefono_cliente) { this.renderBubble(m); this.scroll(); }
                    
                    this.renderList();
                }).subscribe();
            },
            renderList() {
                const list = document.getElementById('inboxList'); list.innerHTML = '';
                const sortedPhones = Object.keys(this.conversations).sort((a,b) => {
                   return this.conversations[b].unread - this.conversations[a].unread;
                });

                if(sortedPhones.length === 0) {
                    list.innerHTML = '<div style="padding:20px; text-align:center; color:#ccc;">No hay mensajes</div>';
                    return;
                }

                sortedPhones.forEach(phone => {
                    const chat = this.conversations[phone];
                    const div = document.createElement('div'); div.className = 'chat-item';
                    const client = admin.data.find(c => c.telefono === phone);
                    const name = client ? `${client.nombre} ${client.apellido}` : phone;
                    const initial = name.charAt(0).toUpperCase();
                    
                    div.innerHTML = `
                        <div class="chat-avatar">${initial}</div>
                        <div class="chat-info">
                            <div class="chat-name">${name}</div>
                            <div class="chat-preview" style="${chat.unread?'font-weight:bold; color:black':''}">${chat.last}</div>
                        </div>
                        ${chat.unread ? '<div class="chat-unread-dot"></div>' : ''}
                    `;
                    div.onclick = () => this.open(phone, name);
                    list.appendChild(div);
                });
            },
            open(phone, name) {
                this.activePhone = phone;
                this.conversations[phone].unread = false;
                document.getElementById('msgNotify').style.display = 'none';
                this.renderList();
                
                const view = document.getElementById('adminChatView');
                view.classList.add('active'); 
                
                document.getElementById('chatActiveUser').textContent = name;
                document.getElementById('chatFooterInput').style.display = 'flex';
                const body = document.getElementById('adminChatBody'); body.innerHTML = '';
                this.conversations[phone].msgs.forEach(m => this.renderBubble(m));
                this.scroll();
            },
            closeMobile() {
                document.getElementById('adminChatView').classList.remove('active');
                this.activePhone = null;
            },
            renderBubble(m) {
                const div = document.createElement('div'); div.className = `msg-bubble ${m.emisor}`;
                div.textContent = m.contenido;
                document.getElementById('adminChatBody').appendChild(div);
            },
            async send() {
                const inp = document.getElementById('adminChatInput');
                const txt = inp.value.trim();
                if(!txt || !this.activePhone) return;
                inp.value = '';
                await supabaseClient.from('mensajes').insert([{ codigo_negocio: admin.code, telefono_cliente: this.activePhone, emisor: 'admin', contenido: txt, leido: true }]);
            },
            scroll() { const b = document.getElementById('adminChatBody'); setTimeout(()=>b.scrollTop=b.scrollHeight,100); }
        };

        const VAPID_PUBLIC_KEY = 'BMhAd4_z7aPvGpv-bk0txj3YePu8D4uN0zoKt-AFu6O7yVv_c6_lXn0bIuwlhOSq6nhUnDF_mLTfbu_z30B902c';

        const pushService = {
            btn: document.getElementById('btn-notif-status'),
            swRegistration: null,

            async init() {
                if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                    this.btn.style.display = 'none';
                    return;
                }
                try {
                    this.swRegistration = await navigator.serviceWorker.register('sw.js');
                    this.updateBtnUI();
                } catch (error) { console.error("SW Error:", error); }
            },

            async enable() {
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') return alert('Permiso denegado.');
                if(!admin.code) return alert('Ingresa tu código primero.');

                try {
                    const subscription = await this.swRegistration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: this.urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                    });

                    await supabaseClient.from('admin_subscriptions').insert({
                            codigo_negocio: admin.code,
                            subscription: subscription
                        });
                    
                    notifications.show('Notificaciones Activadas', 'Recibirás alertas aquí.');
                    this.updateBtnUI();

                } catch (e) { console.error(e); }
            },

            async updateBtnUI() {
                if(!this.swRegistration) return;
                const subscription = await this.swRegistration.pushManager.getSubscription();
                if (subscription) {
                    this.btn.classList.add('active');
                    this.btn.onclick = null;
                } else {
                    this.btn.classList.remove('active');
                    this.btn.onclick = () => this.enable();
                }
            },
            urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
                return outputArray;
            }
        };

        admin.init();
    </script>
</body>
</html>
